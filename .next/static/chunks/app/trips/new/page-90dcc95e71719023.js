(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[162],{3170:function(e,r,t){Promise.resolve().then(t.bind(t,1687))},3289:function(e,r,t){"use strict";var s=t(7437);t(2265),r.Z=e=>{let{title:r="An error occurred",message:t,details:a,suggestion:o="Please try again",actionText:n="Try Again",actionFn:i}=e;return(0,s.jsx)("div",{className:"p-6 max-w-lg mx-auto my-4 bg-white rounded-lg shadow-md border border-red-100",children:(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"flex justify-center mb-4",children:(0,s.jsx)("svg",{className:"w-12 h-12 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",xmlns:"http://www.w3.org/2000/svg",children:(0,s.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:"2",d:"M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"})})}),(0,s.jsx)("h2",{className:"text-xl font-bold text-gray-800 mb-2",children:r}),(0,s.jsx)("p",{className:"text-gray-600 mb-4",children:t}),a&&(0,s.jsx)("div",{className:"mb-4 p-3 bg-gray-50 rounded-md text-sm text-gray-700 text-left overflow-auto max-h-32",children:(0,s.jsx)("p",{className:"font-mono",children:a})}),(0,s.jsx)("p",{className:"text-gray-600 mb-6",children:o}),i&&(0,s.jsx)("button",{onClick:i,className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500",children:n}),(0,s.jsxs)("div",{className:"mt-6 text-xs text-gray-500",children:[(0,s.jsx)("p",{className:"mb-1 font-medium",children:"Troubleshooting Tips:"}),(0,s.jsxs)("ul",{className:"list-disc text-left pl-6",children:[(0,s.jsx)("li",{children:"Check that your Supabase credentials are correct in your .env.local file"}),(0,s.jsx)("li",{children:"Verify that the OpenAI API key is valid"}),(0,s.jsx)("li",{children:"Make sure you've created the 'jobs' table in Supabase"}),(0,s.jsx)("li",{children:"Try clearing your browser cache and refreshing"})]})]})]})})}},1687:function(e,r,t){"use strict";t.d(r,{default:function(){return g}});var s=t(7437),a=t(2265),o=t(9376);let n=e=>"completed"===e,i=e=>"failed"===e;var l=e=>{let{jobId:r,onComplete:t,onError:o,pollingInterval:l=3e3,maxPolls:c=120}=e,[d,u]=(0,a.useState)("queued"),[m,g]=(0,a.useState)(0),[h,p]=(0,a.useState)("Your itinerary is being generated..."),[b,y]=(0,a.useState)(!1),[x,f]=(0,a.useState)(null),[j,v]=(0,a.useState)(0),[w,N]=(0,a.useState)(!1),[k,S]=(0,a.useState)("");(0,a.useEffect)(()=>{if(!r){o("No job ID provided");return}if(n(d)||i(d)||m>=c)return;let e=setTimeout(async()=>{try{console.log("Polling job status for ".concat(r," (attempt ").concat(m+1,")"));let a=Date.now(),n=await fetch("/api/job-status?jobId=".concat(r)),i=Date.now()-a;if(console.log("Job status response received in ".concat(i,"ms, status: ").concat(n.status)),!n.ok){let e;try{e=await n.json(),console.log("Error response body:",e)}catch(r){console.error("Failed to parse error response:",r),e={error:"HTTP Error ".concat(n.status)}}let t={};if(n.headers.forEach((e,r)=>{t[r]=e}),console.log("Response headers:",t),console.error("Error response from job-status API: ".concat(n.status),e),404===n.status){let e=j+1;if(v(e),console.log("Job ".concat(r," not found count: ").concat(e,"/").concat(20)),e>=20){let e="Job ".concat(r," not found after ").concat(20," attempts. The job may have been lost or failed to create properly.");throw console.error(e),S(e),Error(e)}{console.log("Job ".concat(r," not found (attempt ").concat(e,"/").concat(20,"), will retry")),p("Your request is being processed (attempt ".concat(e,"/").concat(20,")..."));let t=Math.min(1e3*Math.pow(1.5,e-1),1e4);console.log("Applying backoff delay of ".concat(t,"ms before next attempt")),await new Promise(e=>setTimeout(e,t)),g(e=>e+1);return}}throw Error(e.error||"Failed to fetch job status")}j>0&&v(0);let l=await n.json();switch(u(l.status),f(l),l.status){case"completed":var e,s;if(null===(e=l.result)||void 0===e?void 0:e.rawContent)console.log("[".concat(r,"] Job contains raw content")),t(l.result);else if(null===(s=l.result)||void 0===s?void 0:s.itinerary)console.log("[".concat(r,"] Job contains parsed itinerary")),t(l.result);else{let e="Completed job has no valid result format";console.error("[".concat(r,"] ").concat(e)),S(e),o(e)}break;case"failed":let c=l.error||"Job failed";console.error("Job ".concat(r," failed:"),c),S(c),o(c),p("The itinerary generation failed. Please try again.");break;case"processing":console.log("Job ".concat(r," is processing")),p("Your itinerary is being created. This may take up to 2 minutes...");break;case"queued":console.log("Job ".concat(r," is queued")),p("Your request is in the queue. Processing will begin shortly...");break;default:console.log("Job ".concat(r," has status: ").concat(l.status)),p("Status: ".concat(l.status))}}catch(e){console.error("Error polling job status:",e),N(!0),S(e.message||"Unknown error"),m>5?o(e.message||"Failed to check job status"):p("Failed to check job status. Retrying...")}g(e=>e+1)},l);return()=>clearTimeout(e)},[r,d,m,c,l,t,o,j]);let E=Math.min(Math.floor(m/c*100),99);return n(d)||i(d)?null:!(m>=c)||n(d)||i(d)?(0,s.jsxs)("div",{className:"mt-4 p-4 bg-blue-50 border border-blue-100 rounded-lg",children:[(0,s.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,s.jsx)("h3",{className:"text-md font-medium text-blue-800",children:"Generating your itinerary"}),(0,s.jsxs)("span",{className:"text-sm text-blue-600",children:[E,"%"]})]}),(0,s.jsx)("div",{className:"w-full bg-gray-200 rounded-full h-2.5",children:(0,s.jsx)("div",{className:"h-2.5 rounded-full ".concat((()=>{switch(d){case"completed":return"bg-green-500";case"failed":return"bg-red-500";case"processing":return"bg-blue-500";default:return"bg-gray-500"}})()),style:{width:"".concat(E,"%")}})}),(0,s.jsx)("p",{className:"text-sm text-blue-700 mt-2",children:h}),w&&(0,s.jsx)("p",{className:"text-xs text-red-600 mt-1",children:"Encountered some connection issues, retrying..."}),(0,s.jsxs)("div",{className:"mt-2 text-xs text-gray-500",children:[(0,s.jsx)("button",{onClick:()=>y(!b),className:"underline focus:outline-none",children:b?"Hide details":"Show details"}),b&&(0,s.jsxs)("div",{className:"mt-2 p-2 bg-gray-100 rounded text-xs overflow-auto",children:[(0,s.jsxs)("p",{children:["Job ID: ",r]}),(0,s.jsxs)("p",{children:["Status: ",d]}),(0,s.jsxs)("p",{children:["Poll count: ",m,"/",c]}),w&&(0,s.jsxs)("p",{className:"text-red-600",children:["Error: ",k]}),x&&(0,s.jsx)("pre",{className:"mt-2",children:JSON.stringify(x,null,2)})]})]}),j>0&&(0,s.jsx)("div",{className:"mt-2 text-xs text-orange-600",children:(0,s.jsxs)("p",{children:["Job not found (attempt ",j,"/",20,"). Still searching..."]})})]}):(0,s.jsxs)("div",{className:"mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-yellow-800",children:"Taking longer than expected"}),(0,s.jsx)("p",{className:"text-sm text-yellow-700 mb-2",children:"Your itinerary is still being generated, but it's taking longer than usual."}),(0,s.jsxs)("div",{className:"flex space-x-3",children:[(0,s.jsx)("button",{onClick:()=>window.location.reload(),className:"px-3 py-1 bg-yellow-600 text-white text-sm rounded hover:bg-yellow-700",children:"Refresh page"}),(0,s.jsx)("button",{onClick:()=>g(0),className:"px-3 py-1 bg-gray-100 text-gray-800 text-sm rounded hover:bg-gray-200",children:"Keep waiting"})]}),k&&(0,s.jsxs)("div",{className:"mt-2 text-xs text-red-700",children:[(0,s.jsxs)("p",{children:["Error details: ",k]}),(0,s.jsx)("p",{className:"mt-1",children:"Try checking your network connection or testing if the API is working."})]})]})},c=t(3289);let d=[{id:"nature",label:"Nature & Outdoors"},{id:"culture",label:"Culture & Arts"},{id:"food",label:"Food & Dining"},{id:"adventure",label:"Adventure Activities"},{id:"relaxation",label:"Relaxation & Wellness"},{id:"history",label:"History & Landmarks"},{id:"nightlife",label:"Nightlife & Entertainment"},{id:"shopping",label:"Shopping"},{id:"family",label:"Family-friendly Activities"}],u=[{id:"vacation",label:"Vacation"},{id:"honeymoon",label:"Honeymoon"},{id:"family",label:"Family Trip"},{id:"solo",label:"Solo Adventure"},{id:"business",label:"Business Trip"},{id:"weekend",label:"Weekend Getaway"},{id:"roadtrip",label:"Road Trip"}],m=[{id:"budget",label:"Budget-friendly",description:"Economical options, hostels, street food"},{id:"moderate",label:"Moderate",description:"Mid-range hotels, some nice restaurants"},{id:"luxury",label:"Luxury",description:"High-end hotels, fine dining, premium experiences"}];function g(){let e=(0,o.useRouter)(),[r,t]=(0,a.useState)("destination"),[n,i]=(0,a.useState)({destination:"",startDate:"",endDate:"",purpose:"",budget:"",preferences:[]}),[g,h]=(0,a.useState)(!1),[p,b]=(0,a.useState)(null),[y,x]=(0,a.useState)(null),[f,j]=(0,a.useState)(null),[v,w]=(0,a.useState)(!1),N=e=>{let{name:r,value:t}=e.target;i({...n,[r]:t})},k=(e,r)=>{i({...n,[e]:r})},S=e=>{let r=n.preferences.includes(e)?n.preferences.filter(r=>r!==e):[...n.preferences,e];i({...n,preferences:r})},E=async()=>{try{w(!0),b(null),j(null);let e=await fetch("/api/test-job"),r=await e.json();if(!e.ok||!r.success)throw Error(r.error||"Connection test failed");return console.log("Job system test successful:",r),!0}catch(e){return console.error("Job system test failed:",e),!1}finally{w(!1)}},I=async()=>{try{let e;if(!await E())throw Error("Job system connection test failed. Please check your Supabase configuration.");h(!0),b(null),j(null),x(null),console.log("Submitting trip form with data:",JSON.stringify(n,null,2)),console.log("Calling API to generate itinerary...");let r=await fetch("/api/generate-itinerary",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)});console.log("API response status:",r.status);try{e=await r.json(),console.log("Raw API response:",e)}catch(e){throw console.error("Error parsing API response:",e),Error("Invalid response format from server")}if(!r.ok){console.error("API error response:",e);let r=e.error||"Failed to generate itinerary";throw Error(r)}if(console.log("Successfully received response from API"),e.jobId){console.log("Received job ID:",e.jobId),x(e.jobId),"completed"===e.status&&P(e.result);return}if(console.log("Received data structure:",Object.keys(e).join(", ")),!e.itinerary)throw console.error("No itinerary data in API response"),Error("API response missing itinerary data");J(e.itinerary)}catch(t){console.error("Error generating itinerary:",t);let e="An unexpected error occurred",r="";if(t instanceof Error){let s=t.message;r=s,e=s.includes("Supabase")?"Database connection error. Please check your Supabase setup.":s.includes("Failed to fetch")||s.includes("NetworkError")?"Network error: Please check your internet connection and try again.":s.includes("timeout")?"The request timed out. Our servers might be busy, please try again.":s.includes("parse")?"There was a problem with the response from our server. Please try again.":s.includes("pattern")?"There was a problem with the data format. Please try again with different preferences.":s.includes("itinerary")?"We had trouble creating your itinerary. Please try again or modify your preferences.":s}b(e),j(r),h(!1)}},P=e=>{console.log("Job completed with result:",e);try{if(e&&e.rawContent){console.log("Processing raw content from OpenAI");try{let r=JSON.parse(e.rawContent);J(r);return}catch(t){console.error("Error parsing raw JSON:",t);let r=e.rawContent.match(/\{[\s\S]*\}/);if(r)try{let e=JSON.parse(r[0]);console.log("Successfully extracted JSON from raw content"),J(e);return}catch(e){console.error("Error parsing extracted JSON:",e)}b("Failed to parse the generated itinerary. Please try again."),j("The AI generated an invalid JSON response."),h(!1);return}}if(e&&e.itinerary){J(e.itinerary);return}throw Error("Invalid result format from job")}catch(e){console.error("Error processing job result:",e),b("Error processing the generated itinerary"),j("Error processing the generated itinerary"),h(!1)}},J=r=>{try{var t;if(console.log("Saving itinerary to localStorage..."),!r.days||!Array.isArray(r.days))throw console.error("Invalid itinerary structure - days array is missing or not an array"),Error("Invalid itinerary structure received");console.log("Itinerary has ".concat(r.days.length," days"));let s=0;for(let e of r.days){if(!e.activities||!Array.isArray(e.activities)){e.activities=[];continue}for(let r of e.activities)r&&"object"==typeof r&&(r.coordinates&&"object"==typeof r.coordinates?("number"!=typeof r.coordinates.lat&&void 0!==r.coordinates.lat?(r.coordinates.lat=parseFloat(String(r.coordinates.lat))||40.7128,s++):void 0===r.coordinates.lat&&(r.coordinates.lat=40.7128,s++),"number"!=typeof r.coordinates.lng&&void 0!==r.coordinates.lng?(r.coordinates.lng=parseFloat(String(r.coordinates.lng))||-74.006,s++):void 0===r.coordinates.lng&&(r.coordinates.lng=-74.006,s++)):(r.coordinates={lat:40.7128,lng:-74.006},s++))}if(s>0&&console.log("Fixed ".concat(s," coordinate issues in the itinerary")),r.days.length>0&&(null===(t=r.days[0].activities)||void 0===t?void 0:t.length)>0){let e=r.days[0].activities[0];console.log("First activity before storing:",{title:e.title,hasCoordinates:!!e.coordinates,coordinates:e.coordinates?JSON.stringify(e.coordinates):"none"});let t=r.days[0].activities.filter(e=>!e.coordinates||"object"!=typeof e.coordinates||void 0===e.coordinates.lat||void 0===e.coordinates.lng);console.log("First day has ".concat(t.length," activities with missing coordinates out of ").concat(r.days[0].activities.length," total"))}let a=JSON.stringify(r);console.log("Stringified length:",a.length),localStorage.setItem("generatedItinerary",a),console.log("Successfully saved to localStorage"),console.log("Navigating to generated trip page..."),e.push("/trips/generated-trip")}catch(e){throw console.error("Error saving to localStorage:",e),Error("Failed to save itinerary data: "+(e instanceof Error?e.message:"Unknown error"))}};return["destination","dates","purpose","budget","preferences"].indexOf(r),(0,s.jsxs)("div",{className:"bg-white rounded-lg shadow-md p-6",children:[(()=>{switch(r){case"destination":return(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"Where do you want to go?"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("label",{htmlFor:"destination",className:"block text-sm font-medium text-gray-700 mb-1",children:"Destination"}),(0,s.jsx)("input",{id:"destination",name:"destination",type:"text",value:n.destination,onChange:N,className:"w-full p-3 border border-gray-300 rounded-md focus:ring-primary focus:border-primary",placeholder:"City, country, or region",required:!0})]})]});case"dates":return(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"When are you traveling?"}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[(0,s.jsxs)("div",{className:"bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200",children:[(0,s.jsx)("label",{htmlFor:"startDate",className:"block text-sm font-medium bg-gray-50 p-3 border-b border-gray-200",children:"Start Date"}),(0,s.jsx)("input",{id:"startDate",name:"startDate",type:"date",value:n.startDate,onChange:N,className:"w-full p-4 text-lg focus:ring-primary focus:border-primary calendar-input",required:!0})]}),(0,s.jsxs)("div",{className:"bg-white rounded-lg overflow-hidden shadow-sm border border-gray-200",children:[(0,s.jsx)("label",{htmlFor:"endDate",className:"block text-sm font-medium bg-gray-50 p-3 border-b border-gray-200",children:"End Date"}),(0,s.jsx)("input",{id:"endDate",name:"endDate",type:"date",value:n.endDate,onChange:N,className:"w-full p-4 text-lg focus:ring-primary focus:border-primary calendar-input",required:!0})]})]}),(0,s.jsx)("p",{className:"text-sm text-gray-500 italic mt-2",children:"Select your travel dates to help us plan the perfect itinerary length."})]});case"purpose":return(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"What's the purpose of your trip?"}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:u.map(e=>(0,s.jsx)("div",{className:"\n                    p-4 border rounded-md cursor-pointer transition-all\n                    ".concat(n.purpose===e.id?"border-primary bg-primary bg-opacity-10":"border-gray-200 hover:border-gray-300 hover:bg-gray-50","\n                  "),onClick:()=>k("purpose",e.id),children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"h-4 w-4 flex items-center justify-center",children:(0,s.jsx)("div",{className:"rounded-full ".concat(n.purpose===e.id?"h-4 w-4 bg-primary":"h-3 w-3 border border-gray-400")})}),(0,s.jsx)("span",{className:"ml-2 text-sm font-medium text-gray-700",children:e.label})]})},e.id))})]});case"budget":return(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"What's your budget range?"}),(0,s.jsx)("div",{className:"space-y-3",children:m.map(e=>(0,s.jsx)("div",{className:"\n                    p-4 border rounded-md cursor-pointer transition-all\n                    ".concat(n.budget===e.id?"border-primary bg-primary bg-opacity-10":"border-gray-200 hover:border-gray-300 hover:bg-gray-50","\n                  "),onClick:()=>k("budget",e.id),children:(0,s.jsxs)("div",{className:"flex items-start",children:[(0,s.jsx)("div",{className:"h-4 w-4 mt-1 flex items-center justify-center",children:(0,s.jsx)("div",{className:"rounded-full ".concat(n.budget===e.id?"h-4 w-4 bg-primary":"h-3 w-3 border border-gray-400")})}),(0,s.jsxs)("div",{className:"ml-2",children:[(0,s.jsx)("span",{className:"text-sm font-medium text-gray-700",children:e.label}),(0,s.jsx)("p",{className:"text-sm text-gray-500",children:e.description})]})]})},e.id))})]});case"preferences":return(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("h2",{className:"text-xl font-semibold",children:"What do you enjoy when traveling?"}),(0,s.jsx)("p",{className:"text-gray-600 text-sm",children:"Select all that apply. This helps us tailor your itinerary."}),(0,s.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:d.map(e=>(0,s.jsx)("div",{className:"\n                    p-3 border rounded-md cursor-pointer transition-all\n                    ".concat(n.preferences.includes(e.id)?"border-primary bg-primary bg-opacity-10":"border-gray-200 hover:border-gray-300 hover:bg-gray-50","\n                  "),onClick:()=>S(e.id),children:(0,s.jsxs)("div",{className:"flex items-center",children:[(0,s.jsx)("div",{className:"h-4 w-4 flex items-center justify-center",children:(0,s.jsx)("div",{className:"".concat(n.preferences.includes(e.id)?"h-3 w-3 bg-primary rounded-sm":"h-3 w-3 border border-gray-400 rounded-sm")})}),(0,s.jsx)("span",{className:"ml-2 text-sm font-medium text-gray-700",children:e.label})]})},e.id))})]})}})(),p&&(0,s.jsx)(c.Z,{title:"Error Generating Itinerary",message:p,details:f||void 0,suggestion:"Please try again or modify your preferences",actionText:"Try Again",actionFn:()=>{b(null),j(null)}}),(0,s.jsxs)("div",{className:"flex justify-between mt-6",children:["destination"!==r&&(0,s.jsx)("button",{type:"button",onClick:()=>{switch(r){case"dates":t("destination");break;case"purpose":t("dates");break;case"budget":t("purpose");break;case"preferences":t("budget")}},disabled:g,className:"px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50",children:"Back"}),(0,s.jsx)("div",{className:"".concat("destination"===r?"ml-auto":""),children:(0,s.jsx)("button",{type:"button",onClick:()=>{switch(r){case"destination":n.destination&&t("dates");break;case"dates":n.startDate&&n.endDate&&t("purpose");break;case"purpose":n.purpose&&t("budget");break;case"budget":n.budget&&t("preferences");break;case"preferences":I()}},disabled:g,className:"px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50",children:"preferences"===r?"Generate Itinerary":"Next"})})]}),g?y?(0,s.jsx)(l,{jobId:y,onComplete:P,onError:e=>{console.error("Job error:",e),b(e),j(e),h(!1)},pollingInterval:2e3,maxPolls:60}):(0,s.jsx)("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:(0,s.jsxs)("div",{className:"bg-white p-6 rounded-lg shadow-lg max-w-md w-full text-center",children:[(0,s.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"}),(0,s.jsx)("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"Generating Your Itinerary"}),(0,s.jsx)("p",{className:"text-sm text-gray-500",children:"This may take up to a minute..."})]})}):null]})}},9376:function(e,r,t){"use strict";var s=t(5475);t.o(s,"useRouter")&&t.d(r,{useRouter:function(){return s.useRouter}})}},function(e){e.O(0,[971,117,744],function(){return e(e.s=3170)}),_N_E=e.O()}]);